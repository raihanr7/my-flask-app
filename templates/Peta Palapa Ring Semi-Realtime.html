<!-- INi syntax peta ya ya ya semangat pagi pagi pagi pagi-->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Peta Palapa Ring (Live Data)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css" />
    <script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-simple-map-screenshoter/dist/leaflet-simple-map-screenshoter.css" />
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter/dist/leaflet-simple-map-screenshoter.js"></script>

    <link href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css" rel="stylesheet">
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.groupedlayercontrol@0.7.0/dist/leaflet.groupedlayercontrol.min.css" />
    <script src="https://unpkg.com/leaflet.groupedlayercontrol@0.7.0/dist/leaflet.groupedlayercontrol.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        #judul-peta {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            color: white;
            background: rgba(0,0,0,0.4);
            padding: 4px 12px;
            border-radius: 8px;
        }
        .legend {
            background: white;
            padding: 10px;
            line-height: 18px;
            font-size: 13px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
        }
        #sidebar {
            position: absolute;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.3);
            z-index: 1001;
            transition: right 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }
        #sidebar.open { right: 0; }
        #closeSidebar {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
        }
        .label-nama {
            font-size: 11px;
            font-weight: bold;
            color: #333;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid #ccc;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }
        .leaflet-control-history { margin-bottom: 8px !important; }
        .leaflet-control-search { margin-top: 0px !important; margin-bottom: 8px !important; }

        /* Supaya tombol custom seragam, tebal, biru, dan kotak */
        .leaflet-control-history a,
        #toggleLabelBtn {
            display: block;
            background-color: #007bff !important;
            color: #fff !important;
            border: none !important;
            border-radius: 5px;
            padding: 8px 14px;
            margin: 8px 0;
            font-size: 15px;
            font-weight: bold;
            text-align: center;
            text-decoration: none !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.15);
            transition: background 0.2s;
            cursor: pointer;
        }

        .leaflet-control-history a:hover,
        #toggleLabelBtn:hover {
            background-color: #0056b3 !important;
        }

        /* Khusus button edit biar biru */
        .btn-edit {
            background: none !important;
            color: #007bff !important;
            border: none !important;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            text-decoration: underline;
            transition: color 0.2s;
            box-shadow: none !important;
        }
        .btn-edit:hover {
            color: #0056b3 !important;
            background: #eaf4ff !important;
        }

        .okupansi-value-container,
        .okupansi-edit-form {
            gap: 3px !important;
        }

        .okupansi-edit-form button {
            font-size: 11px !important;
            padding: 2px 6px !important;
            min-width: 0;
            margin: 0;
        }

        .edit-input {
            width: 50px !important;
            padding: 2px 4px !important;
            font-size: 12px !important;
        }

        .okupansi-edit-form {
            flex-wrap: nowrap !important;
        }

        .okupansi-edit-form,
        .okupansi-display {
            align-items: center !important;
        }

        #sidebar table td {
            vertical-align: middle !important;
        }

        @media (max-width: 500px) {
            #sidebar { width: 95vw !important; }
        }
        
        .notification {
            position: fixed;
            top: 80px;
            right: 30px;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: bold;
            z-index: 99999 !important;  /* Super tinggi supaya selalu di atas! */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            background: #4CAF50;   /* Kalau sukses */
            color: #fff;
        }
        .notification.error {
            background: #f44336 !important;
            color: #fff !important;
        }
        .notification.success {
            background: #4CAF50 !important;
            color: #fff !important;
        }
        
        .leaflet-bar.leaflet-control,
        .leaflet-bar {
            box-shadow: 0 1px 5px rgba(0,0,0,0.12);
            margin-bottom: 4px !important;
            border-radius: 6px;
            overflow: hidden;
        }

        .leaflet-bar a,
        .leaflet-bar button {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            font-size: 20px;
            background: #fff !important;
            color: #333 !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            outline: none;
            transition: background 0.18s;
        }

        .leaflet-bar a:hover,
        .leaflet-bar button:hover {
            background: #eaf4ff !important;
        }

        .leaflet-bar.leaflet-control img,
        .leaflet-bar.leaflet-control svg {
            width: 22px !important;
            height: 22px !important;
            max-width: 22px !important;
            max-height: 22px !important;
            display: block;
            margin: 0 auto;
            padding: 0;
            object-fit: contain;
        }

    </style>
</head>
<body>
    <div id="judul-peta">Peta Jaringan</div>
    <div id="map"></div>
    <div id="sidebar">
        <button id="closeSidebar">Tutup</button>
        <div id="sidebarContent"></div>
    </div>
    <div id="btnToggleLabel" class="leaflet-bar leaflet-control" title="On/Off Label" style="margin-bottom: 4px;">
        <a href="#" style="font-size: 21px; padding: 4px 10px;">üè∑Ô∏è</a>
    </div>
    <!-- Modal Add Marker -->
    <div id="markerModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:99999; background:rgba(0,0,0,0.3);">
        <form id="markerForm" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:28px 22px 16px 22px; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); min-width:260px;">
        <h3 style="margin-bottom:8px; font-size:19px; text-align:center;">Tambah Marker</h3>
        <label>Pilih Kategori:</label><br>
        <select id="kategoriInput" required style="width:100%;margin-bottom:8px;">
            <option value="">--Pilih--</option>
            <option value="backup">Backup Link</option>
            <option value="linksatelit">Link Satelit</option>
            <option value="repair2024">SKKL Repair 2024</option>
            <option value="repair2025">SKKL Repair 2025</option>
            <option value="fo_cut">FO Cut</option>
        </select>
        <label>Nama Site:</label><br>
        <input type="text" id="siteInput" required style="width:100%;margin-bottom:8px;" placeholder="Nama Site"><br>
        <label>Deskripsi:</label><br>
        <input type="text" id="descInput" required style="width:100%;margin-bottom:12px;" placeholder="Deskripsi"><br>
        <div style="display:flex;gap:8px;">
            <button type="submit" style="flex:1;background:#007bff;color:#fff;padding:7px 0;border:none;border-radius:5px;font-weight:bold;">Simpan</button>
            <button type="button" id="batalMarker" style="flex:1;background:#e0e0e0;color:#444;padding:7px 0;border:none;border-radius:5px;">Batal</button>
        </div>
        </form>
    </div>
    <script>
        // Basemap definitions
        const baseLayers = {
            "Google Satellite": L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                attribution: 'Google Satellite'
            }),
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            })
        };
        // Inisialisasi map, default pakai Google Satellite
        const map = L.map('map', {
            layers: [baseLayers["Google Satellite"]]
        }).setView([-2.5, 120], 5);

        const sidebar = document.getElementById("sidebar");
        const sidebarContent = document.getElementById("sidebarContent");

        let currentFeature = null;
        let currentLayer = null;
        let currentTableName = null;
        let isEditMode = false;

        function showSidebar(html) {
            sidebarContent.innerHTML = html;
            sidebar.classList.add("open");
        }
        function hideSidebar() {
            sidebar.classList.remove("open");
            resetEditMode();
        }
        function resetEditMode() {
            currentFeature = null;
            currentLayer = null;
            currentTableName = null;
            isEditMode = false;
        }
        function showNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('fadeOut');
                setTimeout(() => { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 300);
            }, 3000);
        }

        function buildSidebarContent(feature, data, layerInstance, tableName) {
            const order = data.field_order ?? Object.keys(feature.properties);
            let html = "<table>";
            order.forEach(key => {
                let value = feature.properties[key] ?? "-";
                if (key === "Okupansi Telkom (%)" && feature.properties.hasOwnProperty("Okupansi Telkom (%)")) {
                    html += `<tr><td><strong>${key}</strong></td><td style="max-width:120px;">
                        <div class="okupansi-value-container">
                            <div class="okupansi-display" id="okupansiDisplay">
                                <span>: ${value}%</span>
                                <button class="btn-edit" onclick="startEdit()">edit</button>
                            </div>
                            <div class="okupansi-edit-form" id="okupansiEditForm" style="display: none;">
                                <span>:</span>
                                <input type="number" id="okupansiInput" class="edit-input" min="0" max="100" step="0.01" value="${value}" />
                                <span>%</span>
                                <button class="btn-save" onclick="saveOkupansi()">Simpan</button>
                                <button class="btn-cancel" onclick="cancelEdit()">Batal</button>
                                <span id="loadingStatus" class="loading-text" style="display: none;"></span>
                            </div>
                        </div>
                    </td></tr>`;
                } else if (key === "Nilai Kontrak" && value && value !== "-") {
                    html += `<tr><td><strong>${key}</strong></td><td style="max-width:180px;">
                        <div class="nilai-kontrak-value-container">
                            <div class="nilai-kontrak-display" id="nilaiKontrakDisplay">
                                <span>: ${formatRupiah(value)}</span>
                                <button class="btn-edit" onclick="startEditNilaiKontrak()">edit</button>
                            </div>
                            <div class="nilai-kontrak-edit-form" id="nilaiKontrakEditForm" style="display: none; flex-direction: row; align-items: center; gap: 4px;">
                                <span>:</span>
                                <input type="number" id="nilaiKontrakInput" class="edit-input" min="0" step="1000" value="${feature.properties[key]}" style="width:120px;" />
                                <button class="btn-save" onclick="saveNilaiKontrak()">Simpan</button>
                                <button class="btn-cancel" onclick="cancelEditNilaiKontrak()">Batal</button>
                                <span id="loadingStatusNilaiKontrak" class="loading-text" style="display: none;"></span>
                            </div>
                        </div>
                    </td></tr>`;
                } else if (key === "Periode") {
                    html += `<tr><td><strong>${key}</strong></td><td style="max-width:160px;">
                        <div class="periode-value-container">
                            <div class="periode-display" id="periodeDisplay">
                                <span>: ${value}</span>
                                <button class="btn-edit" onclick="startEditPeriode()">edit</button>
                            </div>
                            <div class="periode-edit-form" id="periodeEditForm" style="display: none; flex-direction: row; align-items: center; gap: 4px;">
                                <span>:</span>
                                <input type="text" id="periodeInput" class="edit-input" value="${feature.properties[key] || ''}" style="width:100px;" />
                                <button class="btn-save" onclick="savePeriode()">Simpan</button>
                                <button class="btn-cancel" onclick="cancelEditPeriode()">Batal</button>
                                <span id="loadingStatusPeriode" class="loading-text" style="display: none;"></span>
                            </div>
                        </div>
                    </td></tr>`;
                } else {
                    html += `<tr><td><strong>${key}</strong></td><td>: ${value}</td></tr>`;
                }
            });
            html += "</table>";
            return html;
        }

        function startEdit() {
            if (!currentFeature || !currentTableName) return;
            isEditMode = true;
            document.getElementById('okupansiDisplay').style.display = 'none';
            document.getElementById('okupansiEditForm').style.display = 'flex';
            document.getElementById('okupansiInput').focus();
        }
        function cancelEdit() {
            document.getElementById('okupansiDisplay').style.display = 'flex';
            document.getElementById('okupansiEditForm').style.display = 'none';
            document.getElementById('loadingStatus').style.display = 'none';
            isEditMode = false;
            if (currentFeature) document.getElementById('okupansiInput').value = currentFeature.properties['Okupansi Telkom (%)'] || '';
        }
        
        async function saveOkupansi() {
            if (!currentFeature || !currentTableName) return;

            const okupansiValue = document.getElementById('okupansiInput').value;
            const statusSpan = document.getElementById('loadingStatus');

            const linkName = currentFeature.properties["Link"].trim(); // ambil link
            const project = currentFeature.properties["Project"];
            const kategori = currentTableName.includes('Barat') ? 'barat' :
                            currentTableName.includes('Tengah') ? 'tengah' : 'timur';


            console.log("Nama Project:", project);
            console.log("Nama Link:", linkName);
            console.log("Kategori:", kategori);

            // Validasi input
            if (okupansiValue === '' || isNaN(okupansiValue) || okupansiValue < 0 || okupansiValue > 100) {
                showNotification('Nilai okupansi harus antara 0-100', 'error');
                return;
            }

            const scopeChoice = await Swal.fire({
                title: `Apakah ingin mengubah nilai okupansi menjadi ${okupansiValue}%?`,
                text: 'Silakan pilih',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Hanya link ini',
                denyButtonText: 'Seluruh link pada project ini',
                showDenyButton: true
            });

            if (scopeChoice.dismiss) {
                showNotification('Perubahan dibatalkan.', 'error');
                return;
            }

            const scope = scopeChoice.isConfirmed ? 'link' : 'project';

            statusSpan.style.display = 'inline';
            statusSpan.textContent = 'Menyimpan...';

            try {
                const response = await fetch('/api/update-okupansi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        kategori,
                        scope, // 'link' atau 'project'
                        value: parseFloat(okupansiValue),
                        link_name: linkName, // pakai link sebagai identitas unik
                        project: project
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Okupansi berhasil diupdate', 'success');
                    currentFeature.properties['Okupansi Telkom (%)'] = parseFloat(okupansiValue);
                    document.querySelector('#okupansiDisplay span').textContent = `: ${okupansiValue}%`;

                    if (currentLayer && currentLayer.setStyle) {
                        currentLayer.setStyle(styleAlur(currentFeature));
                    }

                    setTimeout(refreshSpecificLayer, 500);
                    setTimeout(cancelEdit, 1000);
                } else {
                    showNotification(`Error: ${result.error || 'Gagal menyimpan'}`, 'error');
                }
            } catch (error) {
                showNotification('Error: Gagal menghubungi server', 'error');
            } finally {
                statusSpan.style.display = 'none';
            }
        }

        function refreshSpecificLayer() {
            if (!currentTableName) return;
            let projectGroup;
            let alurUrl;
            if (currentTableName.includes('Barat')) {
                projectGroup = groupLayers.PalapaRingBarat;
                alurUrl = `${BASE}/alur/barat`;
            } else if (currentTableName.includes('Tengah')) {
                projectGroup = groupLayers.PalapaRingTengah;
                alurUrl = `${BASE}/alur/tengah`;
            } else if (currentTableName.includes('Timur')) {
                projectGroup = groupLayers.PalapaRingTimur;
                alurUrl = `${BASE}/alur/timur`;
            }
            if(projectGroup) {
                loadGeoJsonFromAPI(alurUrl, "alur", projectGroup.alur);
                setTimeout(() => {
                    projectGroup.all.clearLayers();
                    projectGroup.all.addLayer(projectGroup.alur);
                    projectGroup.all.addLayer(projectGroup.point);
                }, 100);
            }
        }
        document.getElementById("closeSidebar").addEventListener("click", hideSidebar);
        map.on("click", hideSidebar);

        function styleTitik(feature) {
            let warna = "#cccccc";
            if (feature.properties.Keterangan === "Kota Interkoneksi") warna = "#00bfff";
            else if (feature.properties.Keterangan === "Kota Layanan") warna = "#ffff00";
            return { radius: 6, fillColor: warna, color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8 };
        }
        function styleAlur(feature) {
            if (feature.properties.Description) return { color: "#ff9800", weight: 2, opacity: 0.7 };
            const okupansi = parseFloat(feature.properties["Okupansi Telkom (%)"]);
            let warna = "gray";
            if (!isNaN(okupansi)) {
                if (okupansi > 80) warna = "red";
                else if (okupansi >= 50) warna = "yellow";
                else warna = "green";
            }
            return { color: warna, weight: 3, opacity: 0.8 };
        }
        const groupLayers = {
            'PalapaRingBarat': { alur: L.layerGroup(), point: L.layerGroup(), all: L.layerGroup() },
            'PalapaRingTengah': { alur: L.layerGroup(), point: L.layerGroup(), all: L.layerGroup() },
            'PalapaRingTimur': { alur: L.layerGroup(), point: L.layerGroup(), all: L.layerGroup() },
            'submarineCable': L.layerGroup()
        };
        const searchablePointsLayer = L.layerGroup();
        const BASE = "/api";

        const skklRepairLayer = L.layerGroup();
        const skklRepair2024Layer = L.layerGroup();
        const backupLinkLayer = L.layerGroup();
        const linkSatelitLayer = L.layerGroup();
        const foCutLayer = L.layerGroup();



        // LABEL ON/OFF LOGIC
        let labelOn = true;
        let allLabelLayers = [];
        function toggleLabels() {
            labelOn = !labelOn;
            allLabelLayers.forEach(l => {
                if (l.getTooltip()) {
                    if (labelOn) l.openTooltip();
                    else l.closeTooltip();
                }
            });
            document.getElementById('toggleLabelBtn').textContent = labelOn ? 'Matikan Label' : 'Nyalakan Label';
        }

        function loadGeoJsonFromAPI(url, type = 'point', targetGroup) {
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    targetGroup.clearLayers();
                    const kotaMicrowave = ["Sami", "Burmeso", "Elelim", "Wamena", "Kenyam", "Sumohai", "Dekai", "Oksibil", "Kobagma", "Tiom", "Karubaga", "Mulia", "Kepi Tower", "Ilaga", "Sugapa"];
                    const microwaveIcon = L.icon({ iconUrl: '/static/images/microwave.png', iconSize: [24, 24], iconAnchor: [12, 12], popupAnchor: [0, -10] });
                    const layer = L.geoJSON(data, {
                        pointToLayer: (feature, latlng) => {
                            if (type === 'point' && kotaMicrowave.includes(feature.properties.Nama)) return L.marker(latlng, { icon: microwaveIcon });
                            if (type === 'point') return L.circleMarker(latlng, styleTitik(feature));
                        },
                        style: type === 'alur' ? styleAlur : undefined,
                        onEachFeature: function (feature, layer) {
                            layer.on("click", function (e) {
                                L.DomEvent.stopPropagation(e);
                                currentFeature = feature;
                                currentLayer = layer;
                                if (type === 'alur') {
                                    if (url.includes('/alur/barat')) currentTableName = 'Palapa_Ring_Barat_Alur';
                                    else if (url.includes('/alur/tengah')) currentTableName = 'Palapa_Ring_Tengah_Alur';
                                    else if (url.includes('/alur/timur')) currentTableName = 'Palapa_Ring_Timur_Alur';
                                }
                                showSidebar(buildSidebarContent(feature, data, layer, currentTableName));
                                if (layer.getBounds) map.fitBounds(layer.getBounds(), { maxZoom: 9 });
                                else if (layer.getLatLng) map.setView(layer.getLatLng(), 9);
                            });
                            if (type === 'point' && feature.properties.Nama) {
                                layer.bindTooltip(feature.properties.Nama, { permanent: true, direction: 'top', className: 'label-nama' });
                                if (labelOn) layer.openTooltip();
                                else layer.closeTooltip();
                                allLabelLayers.push(layer);
                                layer.options.title = feature.properties.Nama;
                                
                            }
                        }
                    });
                    layer.addTo(targetGroup);
                    layer.eachLayer(l => searchablePointsLayer.addLayer(l)); 
                })
                .catch(err => console.error("Failed to load:", url, err));
        }

        const foCutIcon = L.icon({
            iconUrl: '/static/images/exclamation.png',
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            popupAnchor: [0, -12]
        });

        const repairIcon = L.icon({
            iconUrl: '/static/images/repair.png',
            iconSize: [28, 28], // sesuaikan ukuran
            iconAnchor: [14, 14], // titik tengah icon
            popupAnchor: [0, -14] // popup muncul di atas icon
        });

        const backupLinkIcon = L.icon({
            iconUrl: '/static/images/backuplink.png',
            iconSize: [28, 28], // sesuaikan ukuran
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });

        const linkSatelitIcon = L.icon({
            iconUrl: '/static/images/linksatelit.png',
            iconSize: [28, 28], // sesuaikan dengan ukuran PNG
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });


        function refreshAllLayers() {
            searchablePointsLayer.clearLayers();
            allLabelLayers = [];
            const projects = ['Barat', 'Tengah', 'Timur'];
            projects.forEach(proj => {
                const group = groupLayers[`PalapaRing${proj}`];
                loadGeoJsonFromAPI(`${BASE}/alur/${proj.toLowerCase()}`, "alur", group.alur);
                loadGeoJsonFromAPI(`${BASE}/point/${proj.toLowerCase()}`, "point", group.point);
                setTimeout(() => {
                    group.all.clearLayers();
                    group.all.addLayer(group.alur);
                    group.all.addLayer(group.point);
                }, 200);
            });
            loadGeoJsonFromAPI(`${BASE}/alur/submarine`, "alur", groupLayers.submarineCable);
        }
        
        function loadSKKLRepair2024Layer() {
            fetch('/api/repair/skkl2024')
                .then(res => res.json())
                .then(data => {
                    skklRepair2024Layer.clearLayers();
                    const layer = L.geoJSON(data, {
                        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: repairIcon }),
                        onEachFeature: function (feature, layer) {
                            feature.properties.kategori = 'repair2024';
                            layer.bindPopup(
                                `<b>${feature.properties.name || '-'}</b><br>${feature.properties.description || ''}`
                                + `<br><button onclick="hapusMarker('repair2024', '${feature.properties.id}')"
                                style='margin-top:6px;background:#f44336;color:#fff;border:none;padding:5px 12px;border-radius:5px;cursor:pointer;font-size:13px;'>Hapus</button>`
                            );
                        }
                    });
                    layer.addTo(skklRepair2024Layer);
                });
        }
        function loadSKKLRepairLayer() {
            fetch('/api/repair/skkl')
                .then(res => res.json())
                .then(data => {
                    skklRepairLayer.clearLayers();
                    const layer = L.geoJSON(data, {
                        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: repairIcon }),
                        onEachFeature: function (feature, layer) {
                            feature.properties.kategori = 'repair2025';
                            layer.bindPopup(
                                `<b>${feature.properties.name || '-'}</b><br>${feature.properties.description || ''}`
                                + `<br><button onclick="hapusMarker('repair2025', '${feature.properties.id}')"
                                style='margin-top:6px;background:#f44336;color:#fff;border:none;padding:5px 12px;border-radius:5px;cursor:pointer;font-size:13px;'>Hapus</button>`
                            );
                        }
                    });
                    layer.addTo(skklRepairLayer);
                });
        }


        function loadBackupLinkLayer() {
            fetch('/api/backup-link')
                .then(res => res.json())
                .then(data => {
                    backupLinkLayer.clearLayers();
                    const layer = L.geoJSON(data, {
                        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: backupLinkIcon }),
                        onEachFeature: function (feature, layer) {
                            console.log('ID GEOJSON:', feature.properties.id);
                            feature.properties.kategori = 'backup';
                            layer.bindPopup(
                                `<b>${feature.properties.site || '-'}</b><br>${feature.properties.description || ''}`
                                + `<br><button onclick="hapusMarker('backup', '${feature.properties.id}')"
                                style='margin-top:6px;background:#f44336;color:#fff;border:none;padding:5px 12px;border-radius:5px;cursor:pointer;font-size:13px;'>Hapus</button>`
                            );
                        }
                    });
                    layer.addTo(backupLinkLayer);
                });
        }


        function loadLinkSatelitLayer() {
            fetch('/api/link-satelit')
                .then(res => res.json())
                .then(data => {
                    linkSatelitLayer.clearLayers();
                    const layer = L.geoJSON(data, {
                        pointToLayer: (feature, latlng) => L.marker(latlng, { icon: linkSatelitIcon }),
                        onEachFeature: function (feature, layer) {
                            feature.properties.kategori = 'linksatelit';
                            layer.bindPopup(
                                `<b>${feature.properties.site || '-'}</b><br>${feature.properties.description || ''}`
                                + `<br><button onclick="hapusMarker('linksatelit', '${feature.properties.id}')"
                                style='margin-top:6px;background:#f44336;color:#fff;border:none;padding:5px 12px;border-radius:5px;cursor:pointer;font-size:13px;'>Hapus</button>`
                            );
                        }
                    });
                    layer.addTo(linkSatelitLayer);
                });
        }

        function loadFoCutLayer() {
            fetch('/api/fo-cut/paring')
                .then(res => res.json())
                .then(data => {
                    foCutLayer.clearLayers();
                    const layer = L.geoJSON(data, {
                        pointToLayer: (f, latlng) => L.marker(latlng, { icon: foCutIcon }),
                        onEachFeature: function (feature, layer) {
                            feature.properties.kategori = 'fo_cut';        // ‚Üê penting
                            layer.bindPopup(
                                `<b>${feature.properties.name || '-'}</b><br>${feature.properties.description || ''}` +
                                `<br><button onclick="hapusMarker('fo_cut', '${feature.properties.id}')"` +
                                `style="margin-top:6px;background:#f44336;color:#fff;border:none;padding:5px 12px;border-radius:5px;cursor:pointer;font-size:13px;">Hapus</button>`
                            );
                        }
                    });
                    layer.addTo(foCutLayer);
                });
        }

        loadLinkSatelitLayer();
        setInterval(loadLinkSatelitLayer, 30000);

        loadSKKLRepairLayer();
        setInterval(loadSKKLRepairLayer, 30000);

        loadBackupLinkLayer();
        setInterval(loadBackupLinkLayer, 30000);

        loadSKKLRepair2024Layer();
        setInterval(loadSKKLRepair2024Layer, 30000);
        
        loadFoCutLayer();
        setInterval(loadFoCutLayer, 30000);

        refreshAllLayers();
        setInterval(refreshAllLayers, 30000);
        
        function formatRupiah(nilai) {
            if (!nilai && nilai !== 0) return '-';
            return 'Rp' + Number(nilai).toLocaleString('id-ID', {minimumFractionDigits: 0});
        }

        function startEditNilaiKontrak() {
            document.getElementById('nilaiKontrakDisplay').style.display = 'none';
            document.getElementById('nilaiKontrakEditForm').style.display = 'flex';
            document.getElementById('nilaiKontrakInput').focus();
        }

        function cancelEditNilaiKontrak() {
            document.getElementById('nilaiKontrakDisplay').style.display = 'flex';
            document.getElementById('nilaiKontrakEditForm').style.display = 'none';
            document.getElementById('loadingStatusNilaiKontrak').style.display = 'none';
        }

        async function saveNilaiKontrak() {
            const input = document.getElementById('nilaiKontrakInput');
            const nilaiBaru = input.value;
            const statusSpan = document.getElementById('loadingStatusNilaiKontrak');
            statusSpan.style.display = 'inline';
            statusSpan.textContent = 'Menyimpan...';

            // Pastikan currentFeature dan currentTableName global ya!
            if (!currentFeature || !currentTableName) {
                alert('Data tidak valid.');
                return;
            }
            const fid = currentFeature.properties.fid;
            if (!fid) {
                alert('FID tidak ditemukan');
                return;
            }

            try {
                const res = await fetch(`/api/update/${currentTableName}/${fid}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ "Nilai Kontrak": Number(nilaiBaru) })
                });
                const data = await res.json();

                if (data.affected_rows > 0 || data.message) {
                    showNotification('Nilai kontrak berhasil diupdate', 'success');
                    currentFeature.properties["Nilai Kontrak"] = Number(nilaiBaru);
                    document.querySelector('#nilaiKontrakDisplay span').textContent = `: ${formatRupiah(nilaiBaru)}`;
                    setTimeout(cancelEditNilaiKontrak, 800);
                } else {
                    showNotification('Gagal update nilai kontrak', 'error');
                }
            } catch (err) {
                showNotification('Gagal koneksi ke server', 'error');
            } finally {
                statusSpan.style.display = 'none';
            }
        }

        function startEditPeriode() {
            document.getElementById('periodeDisplay').style.display = 'none';
            document.getElementById('periodeEditForm').style.display = 'flex';
            document.getElementById('periodeInput').focus();
        }

        function cancelEditPeriode() {
            document.getElementById('periodeDisplay').style.display = 'flex';
            document.getElementById('periodeEditForm').style.display = 'none';
            document.getElementById('loadingStatusPeriode').style.display = 'none';
        }

        async function savePeriode() {
            const input = document.getElementById('periodeInput');
            const periodeBaru = input.value;
            const statusSpan = document.getElementById('loadingStatusPeriode');
            statusSpan.style.display = 'inline';
            statusSpan.textContent = 'Menyimpan...';

            if (!currentFeature || !currentTableName) {
                alert('Data tidak valid.');
                return;
            }
            const fid = currentFeature.properties.fid;
            if (!fid) {
                alert('FID tidak ditemukan');
                return;
            }

            try {
                const res = await fetch(`/api/update/${currentTableName}/${fid}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ "Periode": periodeBaru })
                });
                const data = await res.json();

                if (data.affected_rows > 0 || data.message) {
                    showNotification('Periode berhasil diupdate', 'success');
                    currentFeature.properties["Periode"] = periodeBaru;
                    document.querySelector('#periodeDisplay span').textContent = `: ${periodeBaru}`;
                    setTimeout(cancelEditPeriode, 800);
                } else {
                    showNotification('Gagal update periode', 'error');
                }
            } catch (err) {
                showNotification('Gagal koneksi ke server', 'error');
            } finally {
                statusSpan.style.display = 'none';
            }
        }

        // LEGEND
        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function () {
            const div = L.DomUtil.create("div", "legend");
            div.innerHTML = "<h4>Keterangan Peta</h4>" +
                "<hr>" +
                "<img src='/static/images/microwave.png' style='width:18px; height:18px; margin-right:8px;'>Microwave/Radio<br>" +
                "<img src='/static/images/backuplink.png' style='width:18px; height:18px; margin-right:8px;'>Backup Link<br>" +
                "<img src='/static/images/linksatelit.png' style='width:18px; height:18px; margin-right:8px;'>Link Satelit<br>" +
                "<img src='/static/images/repair.png' style='width:18px; height:18px; margin-right:8px;'>Repair SKKL<br>" +
                "<img src='/static/images/exclamation.png' style='width:18px;height:18px;margin-right:8px;'>FO¬†Cut<br>" +
                "<hr>" +
                "<i style='background:#00bfff'></i> Kota Interkoneksi<br>" +
                "<i style='background:#ffff00'></i> Kota Layanan<br>" +
                "<i style='background:#ff9800'></i> Submarine Cable<br>" +
                "<hr>" +
                "<i style='background:green'></i> Okupansi < 50%<br>" +
                "<i style='background:yellow'></i> Okupansi 50‚Äì80%<br>" +
                "<i style='background:red'></i> Okupansi > 80%<br>";
            return div;
        };
        legend.addTo(map);

        // LAYER CONTROL (baseLayers & overlays)
        L.control.layers(baseLayers, {
            "Palapa Ring Barat": groupLayers.PalapaRingBarat.all,
            "Palapa Ring Tengah": groupLayers.PalapaRingTengah.all,
            "Palapa Ring Timur": groupLayers.PalapaRingTimur.all,
            "Submarine Cable": groupLayers.submarineCable,
            "SKKL Repair 2025": skklRepairLayer,
            "SKKL Repair 2024": skklRepair2024Layer,
            "Backup Link": backupLinkLayer,
            "Link Satelit": linkSatelitLayer,
            "FO Cut": foCutLayer
        }).addTo(map);

        // UPDATE HISTORY CONTROL
        L.Control.HistoryIcon = L.Control.extend({
        onAdd: function(map) {
            var btn = L.DomUtil.create('a', '');
            btn.href = '/history';
            btn.innerHTML = '‚è≥';
            btn.title = 'Update History';
            btn.style.fontSize = '20px';
            btn.style.padding = '4px 4px';
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.appendChild(btn);
            return container;
        }
        });
        new L.Control.HistoryIcon({ position: 'topleft' }).addTo(map);

        L.Control.LabelIcon = L.Control.extend({
        onAdd: function(map) {
            var btn = L.DomUtil.create('a', '');
            btn.href = '#';
            btn.innerHTML = 'üè∑Ô∏è';
            btn.title = 'On/Off Label';
            btn.style.fontSize = '21px';
            btn.style.padding = '2px 2px';
            btn.onclick = function(e) {
            e.preventDefault(); toggleLabels();
            };
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.appendChild(btn);
            return container;
        }
        });
        new L.Control.LabelIcon({ position: 'topleft' }).addTo(map);


        // SEARCH CONTROL
        const searchCtl = new L.Control.Search({
            position: 'topleft',
            layer: searchablePointsLayer,
            propertyName: 'title',
            marker: false,
            textPlaceholder: 'Cari nama lokasi...',
            textErr: 'Lokasi tidak ditemukan',
            moveToLocation: function (latlng, title, map) {
                map.setView(latlng, 10);
            }
        });

        map.addControl(searchCtl);

        /* ‚îÄ‚îÄ setelah kontrol terpasang, buang layer‚Äënya dari peta
            supaya marker tidak langsung tampil saat peta pertama kali dibuka */
        if (map.hasLayer(searchablePointsLayer)) {
            map.removeLayer(searchablePointsLayer);
        }
        
        map.pm.addControls({
            position: 'topleft',
            drawCircle: false,
            drawCircleMarker: false,
            drawMarker: true,
            drawRectangle: false,
            drawPolygon: false,
            drawText: false,
            drawPolyline: true,
            editMode: false,
            dragMode: false,
            cutPolygon: false,
            removalMode: true,
            rotateMode: false
        });

        let tempMarker = null;
        let tempLatLng = null;

        map.on('pm:create', function(e) {
            if (e.layer instanceof L.Marker) {
                tempMarker = e.layer;
                tempLatLng = e.layer.getLatLng();
                document.getElementById('markerModal').style.display = '';
                document.getElementById('kategoriInput').value = '';
                document.getElementById('siteInput').value = '';
                document.getElementById('descInput').value = '';
            }
            // Polyline tetap menampilkan jarak
            if (e.layer instanceof L.Polyline) {
                var latlngs = e.layer.getLatLngs();
                var total = 0;
                for (var i = 1; i < latlngs.length; i++) {
                    total += latlngs[i-1].distanceTo(latlngs[i]);
                }
                var label = "Jarak total: " + (total/1000).toFixed(2) + " km";
                e.layer.bindPopup(label).openPopup();
            }
        });

        document.getElementById('markerForm').onsubmit = function(ev) {
            ev.preventDefault();
            const kategori = document.getElementById('kategoriInput').value;
            const site = document.getElementById('siteInput').value;
            const description = document.getElementById('descInput').value;
            if (!kategori || !site || !description) {
                alert('Semua field wajib diisi.');
                return;
            }
            fetch('/api/tambah-marker', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    kategori,
                    lat: tempLatLng.lat,
                    lng: tempLatLng.lng,
                    site,
                    description
                })
            }).then(r => r.json()).then(data => {
                document.getElementById('markerModal').style.display = 'none';
                if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
                if (data.success) {
                    alert('Marker berhasil ditambah!');
                    if (kategori === 'linksatelit') loadLinkSatelitLayer();
                    else if (kategori === 'backup') loadBackupLinkLayer();
                    else if (kategori === 'repair2024') loadSKKLRepair2024Layer();
                    else if (kategori === 'repair2025') loadSKKLRepairLayer();
                    else if (kategori === 'fo_cut') loadFoCutLayer();  
                } else {
                    alert('Gagal menambah marker!');
                }
            }).catch(err => {
                alert('Gagal koneksi ke server!');
            });
        };

        document.getElementById('batalMarker').onclick = function() {
        document.getElementById('markerModal').style.display = 'none';
            if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
        };


        map.on('pm:remove', function(e) {
            // Cek kalau yang dihapus marker
            if (e.layer instanceof L.Marker) {
                // Ambil kategori dan id marker
                // Pastikan property sudah di-set waktu loader geojson
                const feature = e.layer.feature;
                if (!feature || !feature.properties || !feature.properties.id) return;
                let kategori = null;
                // Deteksi kategori marker
                if (feature.properties.site && !feature.properties.name) {
                    // Backup Link atau Link Satelit
                    // (Harus pakai loader GeoJSON yang nambah kategori)
                    // Bisa cek dengan if (e.target === backupLinkLayer) dsb, atau tambahkan field kategori di properties
                    // Cara termudah, tambahkan kategori di properties waktu loader GeoJSON!
                    kategori = feature.properties.kategori; // set ini waktu loader
                } else if (feature.properties.name) {
                    if (feature.properties.kategori) kategori = feature.properties.kategori;
                    else kategori = feature.properties.name.includes('2024') ? 'repair2024' : 'repair2025'; // fallback
                }
                if (!kategori) {
                    alert('Kategori marker tidak diketahui. Tidak bisa hapus dari database!');
                    return;
                }
                // Konfirmasi
                if (!confirm('Yakin ingin menghapus marker ini dari database?')) return;
                // Hapus dari database via AJAX
                fetch('/api/delete-marker', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ kategori, id: feature.properties.id })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        alert('Marker berhasil dihapus dari database!');
                        // Refresh layer sesuai kategori
                        if (kategori === 'linksatelit') loadLinkSatelitLayer();
                        else if (kategori === 'backup') loadBackupLinkLayer();
                        else if (kategori === 'repair2024') loadSKKLRepair2024Layer();
                        else if (kategori === 'repair2025') loadSKKLRepairLayer();
                        else if (kategori === 'fo_cut') loadFoCutLayer();  
                    } else {
                        alert('Gagal hapus marker dari database!');
                    }
                });
            }
        });

        window.hapusMarker = function(kategori, id) {
            if (!confirm('Yakin ingin menghapus marker ini?')) return;
            fetch('/api/delete-marker', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ kategori, id })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    alert('Berhasil dihapus!');
                    if (kategori === 'linksatelit') loadLinkSatelitLayer();
                    else if (kategori === 'backup') loadBackupLinkLayer();
                    else if (kategori === 'repair2024') loadSKKLRepair2024Layer();
                    else if (kategori === 'repair2025') loadSKKLRepairLayer();
                } else {
                    alert('Gagal hapus marker!');
                }
            });
        };

        map.on('pm:dragend', async e => {
        // Hanya tangani marker
            if (!(e.layer instanceof L.Marker)) return;

            const { feature } = e.layer;
            if (!feature || !feature.properties || !feature.properties.id) return;

            // Kategori sudah diset saat loader GeoJSON
            const kategori = feature.properties.kategori;   // backup / linksatelit / ‚Ä¶
            const { lat, lng } = e.layer.getLatLng();

            try {
                const res = await fetch('/api/update-marker', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kategori, id: feature.properties.id, lat, lng })
                });
                const data = await res.json();

                if (data.success) {
                    alert('Posisi marker berhasil diperbarui!');

                    // === REFRESH LAYER SESUAI KATEGORI ===
                    if (kategori === 'linksatelit')       loadLinkSatelitLayer();
                    else if (kategori === 'backup')       loadBackupLinkLayer();
                    else if (kategori === 'repair2024')   loadSKKLRepair2024Layer();
                    else if (kategori === 'repair2025')   loadSKKLRepairLayer(); 
                    else if (kategori === 'fo_cut')       loadFoCutLayer(); 
                    // =====================================
                } else {
                    alert('Gagal update lokasi di database: ' + (data.error || ''));
                }
            } catch (err) {
                alert('Gagal koneksi ke server');
            }
        });

        // SCREENSHOTTER
        var screenshoter = L.simpleMapScreenshoter({
            cropImageByInnerWH: true,
            hidden: false,
            preventDownload: false,
            hideElementsWithSelectors: ['body > *:not(#map)'],
            domtoimageOptions: { 
                bgcolor: '#ffffff',
                style: {
                    transform: 'scale(1)',
                    transformOrigin: 'top left'
                } 
            },
            screenName: 'skkl-map',
            position: 'topright'
        }).addTo(map);
        
        document.getElementById('btnToggleLabel').onclick = function(e) {
            e.preventDefault();
            toggleLabels(); // function sudah ada di script kamu
        };

    
    </script>
</body>
</html>
